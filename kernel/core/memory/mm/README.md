# 仮想メモリマネージャ (Memory Manager)

仮想メモリマネージャは、AetherOSカーネルの仮想アドレス空間管理と物理メモリのマッピングを担当する核心的コンポーネントです。ハードウェアMMU（メモリ管理ユニット）と緊密に連携し、プロセスごとの仮想アドレス空間を効率的かつ安全に管理します。

## 主要機能

- **ページテーブル管理**: 複数レベルのページテーブル構造を管理し、アドレス変換を効率化
- **オンデマンドページング**: 必要に応じてメモリをマッピングし、メモリ使用効率を向上
- **共有メモリ**: プロセス間で効率的にメモリを共有する機能
- **メモリ保護**: カーネル空間とユーザー空間の厳格な分離と保護
- **先進的なメモリマッピング**: 大容量ページ、非キャッシュメモリ、書き込み合体など特殊なマッピングをサポート
- **ハードウェアアシスト活用**: EPT、SMEP、SMAP、MCE等のハードウェア機能を最大限に活用
- **アドレス空間レイアウトランダム化 (ASLR)**: セキュリティ強化のためのアドレス空間配置のランダム化

## コンポーネント

- `page.rs`: ページ管理の基本機能とページテーブル操作
- `fault.rs`: ページフォルトハンドラと例外管理
- `allocation.rs`: 仮想アドレス空間の割り当てと管理
- `mapping.rs`: 物理メモリと仮想アドレスのマッピング操作
- `protection.rs`: メモリ保護とアクセス権管理
- `tlb.rs`: TLB (Translation Lookaside Buffer) の管理と操作
- `hugepage.rs`: 大容量ページ (Hugepage) のサポート
- `special.rs`: 特殊なメモリ領域（デバイスメモリ、非キャッシュメモリなど）の管理

## アーキテクチャ

仮想メモリマネージャは以下の階層構造で設計されています：

1. **アーキテクチャ依存層**: x86_64, ARM64等のCPUアーキテクチャ固有の実装
2. **共通抽象層**: アーキテクチャに依存しない共通インターフェースと操作
3. **ポリシー層**: メモリ配置、割り当て戦略、最適化を担当
4. **拡張機能層**: 先進的な機能（ハイパーバイザー対応、IOMMU連携等）

## 高度な機能

### ゼロコピーマッピング

ファイルとメモリマッピングの統合により、データコピーを最小限に抑えたI/O操作を実現します。

```rust
// ファイルを仮想メモリに直接マッピング
let mapping = mm::map_file(file, addr, size, protection);
```

### リモートメモリアクセス

RDMA (Remote Direct Memory Access) 技術と統合し、ネットワーク経由のメモリアクセスをサポートします。

```rust
// リモートノードのメモリをローカルアドレス空間にマッピング
let remote_mapping = mm::map_remote_memory(node_id, remote_addr, size, local_addr);
```

### メモリティアリング

メモリアクセスパターンに基づいて、適切なメモリ階層（HBM, DRAM, PMEM等）へ自動的にデータを配置します。

```rust
// ヒント付きマッピング
let tiered_mapping = mm::map_with_tier_hint(addr, size, MemoryTier::HighBandwidthMemory);
```

## パフォーマンス最適化

- **スレッド局所ページテーブル更新**: 同時実行時のロックコンテンションを最小化
- **TLB射影**: TLBの効率的な使用によるアドレス変換のオーバーヘッド削減
- **スマートプリフェッチ**: アクセスパターン予測に基づくページのプリロード
- **バッチ処理最適化**: 複数ページ操作のバッチ化によるパフォーマンス向上

## 関連コンポーネント

- **バディアロケータ**: 物理メモリの割り当てを担当
- **スラブアロケータ**: 小サイズのメモリオブジェクト管理
- **量子メモリアクセラレーション**: 先進的なメモリアクセス予測と最適化
- **自己修復メモリシステム**: エラー検出と自動修復機能

## 設定パラメータ

主要な設定パラメータ:

- `PAGE_SIZE`: 基本ページサイズ（通常4KB）
- `HUGEPAGE_SIZE`: 大容量ページサイズ（2MB/1GBをサポート）
- `KERNEL_BASE`: カーネル仮想アドレス空間の開始位置
- `USER_BASE`: ユーザー仮想アドレス空間の開始位置
- `MAX_MMAP_AREAS`: プロセスあたりの最大マッピング領域数 