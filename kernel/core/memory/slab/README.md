# スラブアロケータ (Slab Allocator)

スラブアロケータは小・中サイズのメモリオブジェクトを効率的に管理するためのメモリ割り当てシステムです。カーネル内の同じサイズのオブジェクトを管理し、フラグメンテーションを減らしつつ、高速なメモリ割り当て・解放を実現します。

## 主要機能

- **オブジェクトキャッシング**: 解放されたオブジェクトを再利用し、メモリ割り当ての効率を向上
- **サイズ別管理**: 異なるサイズのオブジェクト用に最適化されたメモリプール
- **メモリアライメント**: キャッシュライン境界に合わせたオブジェクト配置による性能向上
- **スラブカラーリング**: キャッシュのセット連想衝突を軽減するカラーリング機構
- **アロケーションアファイニティ**: NUMAシステムでのノード局所性を考慮した割り当て
- **スラブ圧縮**: 未使用スラブの動的再利用による効率化
- **統計追跡**: 詳細なアロケーション統計による性能分析と最適化

## コンポーネント

- `slab.rs`: スラブアロケータの中核実装
- `cache.rs`: オブジェクトキャッシュ管理
- `depot.rs`: スラブデポ（スラブの集中管理）
- `object.rs`: オブジェクト操作とメタデータ管理
- `color.rs`: スラブカラーリング実装
- `stats.rs`: 統計情報収集と分析

## スラブ構造設計

### 階層構造

スラブアロケータは3段階の階層構造で設計されています：

1. **キャッシュ層**: 特定のオブジェクトタイプまたはサイズのコンテナ
2. **スラブ層**: 複数の同サイズオブジェクトを含む連続メモリ領域
3. **オブジェクト層**: 実際のデータを格納する個々のメモリブロック

### メモリレイアウト

標準的なスラブのメモリレイアウト：

```
+----------------+----------------+----------------+-----+----------------+
| スラブヘッダ   | オブジェクト1  | オブジェクト2  | ... | オブジェクトN  |
+----------------+----------------+----------------+-----+----------------+
```

## 使用方法

### 基本的な使用例

```rust
// オブジェクトキャッシュの作成
let cache = slab::create_cache::<MyStruct>("my_struct_cache");

// オブジェクトの割り当て
let obj = cache.allocate().unwrap();

// オブジェクトの初期化と使用
obj.field1 = value1;
obj.field2 = value2;

// オブジェクトの解放
cache.free(obj);
```

### 高度な設定によるキャッシュ作成

```rust
// カスタム設定を持つキャッシュの作成
let config = CacheConfig {
    min_objects: 16,         // 最小オブジェクト数
    alignment: 64,           // キャッシュライン境界に合わせる
    numa_affinity: true,     // NUMAノード親和性を有効化
    reclaim_policy: ReclaimPolicy::Immediate, // 即時再利用ポリシー
    color_count: 8,          // カラー値の数
};

let advanced_cache = slab::create_cache_with_config::<ComplexStruct>("complex_cache", config);
```

## 最適化技術

### スラブカラーリング

キャッシュ競合を減らすためのオフセット変動：

```
スラブ1：[ヘッダ][カラーオフセット0][オブジェクト1][オブジェクト2]...
スラブ2：[ヘッダ][カラーオフセット1][オブジェクト1][オブジェクト2]...
スラブ3：[ヘッダ][カラーオフセット2][オブジェクト1][オブジェクト2]...
```

### スラブ合体・分割

メモリ使用効率を高めるための動的スラブ管理：

- **スラブ合体**: 使用率の低い隣接スラブの統合
- **スラブ分割**: アクセスパターンに基づく大きなスラブの分割

### NUMAアウェア割り当て

マルチソケットシステムでのパフォーマンス最適化：

- **ノード局所的キャッシュ**: 各NUMAノードに専用のスラブキャッシュを配置
- **クロスノードアクセス最小化**: プロセッサに近いメモリからの優先的割り当て
- **動的リバランシング**: アクセスパターンに基づくスラブの再分配

## 拡張機能

### オブジェクト構築・破棄フック

```rust
// コンストラクタ・デストラクタ付きキャッシュ
let lifecycle_cache = slab::create_cache_with_hooks::<MyStruct>(
    "lifecycle_cache",
    |obj| { /* コンストラクタ処理 */ },
    |obj| { /* デストラクタ処理 */ }
);
```

### オンデマンドスラブ展開

メモリ効率を高めるためのオンデマンド割り当て：

```rust
let lazy_cache = slab::create_cache_with_policy::<HugeStruct>(
    "lazy_cache",
    AllocationPolicy::OnDemand
);
```

## パフォーマンス特性

- **割り当て時間**: 平均O(1)の定数時間割り当て
- **解放時間**: O(1)の定数時間解放
- **メモリオーバーヘッド**: オブジェクトサイズに応じて約3-8%
- **局所性**: 同種オブジェクトの高いメモリ局所性によるキャッシュヒット率向上

## モニタリングと診断

スラブアロケータの状態と性能を監視するためのツール：

```rust
// 全キャッシュの統計情報を取得
let stats = slab::get_global_stats();

// 特定キャッシュの詳細情報
let cache_info = slab::get_cache_info("my_struct_cache");

// 診断出力
slab::dump_cache_info("my_struct_cache");
```

## 関連コンポーネント

- **バディアロケータ**: スラブに基盤ページを提供
- **メモリ圧縮**: 非アクティブスラブの圧縮によるメモリ効率向上
- **量子メモリアクセラレーション**: スラブアクセスパターンの最適化
- **自己修復メモリ**: スラブ破損の検出と修復 