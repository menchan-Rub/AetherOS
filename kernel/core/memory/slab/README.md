# AetherOS スラブアロケータ

## 概要

AetherOSスラブアロケータは同じサイズのメモリオブジェクトを効率的に割り当てるために設計されたメモリ管理システムです。スラブアロケータは、特に小さなオブジェクトの割り当てと解放を高速化し、メモリの断片化を軽減します。

## 特徴

- **サイズクラス別の最適化**: 一般的なサイズのオブジェクト用に最適化されたキャッシュ
- **フリーリスト管理**: 高速なメモリの割り当てと解放
- **キャッシュカラーリング**: キャッシュライン競合を減少させるためのメモリオフセット最適化
- **型安全なAPI**: Rustの型システムを活用した安全なメモリ管理
- **スコープベースのリソース管理**: `SlabObjectGuard`によるRIIパターンの実装
- **専用キャッシュ**: 特定の構造体用にカスタマイズされたキャッシュの作成機能
- **NUMA対応**: 将来的なNUMAノード別の最適化サポート
- **PMEM対応**: 永続メモリ（PMEM）領域のサポート

## アーキテクチャ

スラブアロケータは以下のコンポーネントで構成されています：

### SlabPage

物理ページを基にした同一サイズのオブジェクト群を管理します。各スラブページには以下の状態があります：

- `Free`: すべてのオブジェクトが未使用
- `PartiallyUsed`: 一部のオブジェクトが使用中
- `Full`: すべてのオブジェクトが使用中

### SlabCache

特定サイズのオブジェクト用のキャッシュです。複数のスラブページを管理し、効率的なメモリ割り当てを提供します。キャッシュカラーリングを実装しており、メモリアクセスパターンを最適化します。

### SlabAllocator

複数のスラブキャッシュを管理するコンポーネントです。一般的なサイズ用のキャッシュと特殊な構造体用の専用キャッシュを提供します。

### SlabAllocatorManager

システム全体のスラブアロケータを管理します。NUMA対応の拡張性を備えています。

### SlabObject

スラブアロケータによって管理されるメモリブロックの基本単位です。フリーリストによって連結され、効率的なメモリ管理を実現します。

### SlabObjectGuard

スコープベースのメモリ管理を提供するガード構造体です。スコープを抜けるとメモリが自動的に解放されます。

## 使用方法

### 基本的なメモリ割り当て

```rust
// スラブアロケータを初期化
SlabAllocatorAPI::initialize().unwrap();

// 64バイトのメモリを割り当て
let ptr = SlabAllocatorAPI::allocate(64).unwrap();

// メモリを解放
SlabAllocatorAPI::free(ptr, 64).unwrap();
```

### 型指定割り当て

```rust
struct MyStruct {
    id: u32,
    data: [u8; 32],
}

// MyStruct用のメモリを割り当て
let ptr = SlabAllocatorAPI::allocate_typed::<MyStruct>().unwrap();

// メモリを解放
SlabAllocatorAPI::free_typed(ptr).unwrap();
```

### オブジェクトガードの使用

```rust
struct MyStruct {
    id: u32,
    data: [u8; 32],
}

// ガード付きでオブジェクトを割り当て
if let Some(mut obj) = SlabAllocatorAPI::allocate_object::<MyStruct>() {
    // オブジェクトを使用
    obj.id = 42;
    obj.data.fill(0);
    
    // スコープを抜けると自動的に解放される
}
```

### 専用キャッシュの作成

```rust
struct NetworkPacket {
    header: [u8; 40],
    payload: [u8; 1500],
}

// NetworkPacket用の専用キャッシュを作成
let cache = SlabAllocatorAPI::create_object_cache::<NetworkPacket>("net-packet").unwrap();

// キャッシュからオブジェクトを割り当て
let mut packet = cache.allocate().unwrap();

// オブジェクトを使用
packet.header.fill(0);
packet.payload[0] = 42;

// スコープを抜けると自動的に解放される
```

## パフォーマンス最適化

スラブアロケータは以下の最適化を実装しています：

1. **キャッシュカラーリング**: オブジェクトの開始位置をランダム化し、キャッシュライン競合を軽減
2. **スラブ状態管理**: 効率的な割り当てのために空き/部分使用/満杯のスラブリストを管理
3. **高速なリスト操作**: フリーリストを使用した高速なメモリ割り当てと解放
4. **適応型アロケーション**: 使用パターンに基づいてメモリ割り当てを最適化

## 将来の拡張

- 完全なNUMA対応の実装
- PMEMを使用したスラブの永続化
- 高度なメモリ使用統計と監視機能
- メモリ圧縮と再配置アルゴリズム 