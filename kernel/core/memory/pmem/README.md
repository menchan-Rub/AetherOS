# 不揮発性メモリ管理 (Persistent Memory Manager)

不揮発性メモリ (PMEM) 管理モジュールは、Intel Optane DCPMやNVDIMM-N/NVDIMM-Pなどの永続メモリデバイスを効率的に管理するためのサブシステムです。従来のストレージとメモリの境界を超え、不揮発性と低レイテンシの両方の特性を活かした最適なデータ管理を実現します。

## 特徴と機能

- **ハイブリッドメモリ管理**: DRAMとPMEMを統合的に管理し、アプリケーションに透過的な使用を提供
- **永続性保証**: システム障害やパワーロス後もデータを確実に保持するための一貫性機構
- **トランザクション機能**: 原子的な永続データ操作を保証するACID（Atomicity, Consistency, Isolation, Durability）トランザクション
- **高速書き込みパス**: 並行処理とバッファリングを最適化した低レイテンシ書き込みパス
- **DAXサポート**: Direct Access（DAX）によるファイルシステムバイパスを実現
- **マルチレベルキャッシュ統合**: DRAMをキャッシュとして活用したPMEM性能向上
- **障害回復メカニズム**: データ損失を最小限に抑える高度な障害回復機能

## コンポーネント構成

- `allocator.rs`: PMEM専用メモリアロケータ
- `btree.rs`: 永続型B+木の実装
- `log.rs`: 先行書き込みログ（Write-Ahead Logging）実装
- `transaction.rs`: トランザクション管理
- `consistency.rs`: データ一貫性保証機能
- `recovery.rs`: クラッシュリカバリ機構
- `dax.rs`: Direct Access（DAX）サポート
- `pool.rs`: PMEM領域のプール管理

## アーキテクチャ

PMEMマネージャは以下の階層構造で設計されています：

1. **デバイス層**: 物理PMEMデバイスとの直接インターフェース
2. **領域管理層**: PMEM空間の割り当てと管理
3. **永続性層**: データの永続性と一貫性を保証
4. **最適化層**: パフォーマンス向上のための機能（キャッシュ、先読み等）
5. **アプリケーション層**: カーネルとユーザーアプリケーションへのインターフェース

## メモリモデル

### ハイブリッドアクセスモード

PMEMは複数のアクセスモードを提供します：

1. **メモリマップモード**: PMEMを通常のメモリとして使用
2. **永続オブジェクトモード**: 構造化データを永続的に保存
3. **ブロックデバイスモード**: 従来のブロックデバイスとしての使用
4. **ファイルバックドモード**: メモリマップドファイルとしての使用

### キャッシュ階層

パフォーマンス最適化のための階層的キャッシュ構造：

- **L1**: プロセッサキャッシュ（揮発性）
- **L2**: DRAM階層（揮発性バッファ）
- **L3**: PMEM階層（非揮発性ストレージ）

## 使用例

基本的なPMEMオブジェクト操作：

```rust
// 永続メモリ領域の確保
let pmem_region = pmem::allocate_region(size);

// 永続オブジェクトの作成
let persistent_obj = pmem::create_persistent_object::<MyStruct>(pmem_region);

// トランザクション内での更新
pmem::transaction::begin();
persistent_obj.update_field(new_value);
pmem::transaction::commit();
```

階層型メモリ設定例：

```rust
// ホットデータをDRAMにキャッシュしつつPMEMに永続化
let memory_config = HybridMemoryConfig {
    primary_storage: MemoryTier::PMEM,
    cache_tier: MemoryTier::StandardDRAM,
    write_policy: WritePolicy::WriteBack,
    persistence_level: PersistenceLevel::Transaction,
};

// 設定を適用した永続オブジェクトの作成
let hybrid_object = pmem::create_hybrid_object::<LargeDataStruct>(memory_config);
```

## パフォーマンス考慮事項

- **キャッシュライン粒度**: 書き込み操作をキャッシュラインサイズ（64バイト）に合わせることでパフォーマンスを最適化
- **NTストア**: Non-Temporal（NT）ストア命令を使用してキャッシュをバイパス
- **フェンス操作**: 適切なメモリフェンスを使用してストア順序を保証
- **PMEMウェアレベリング**: 書き込み操作の均等分散によるデバイス寿命延長

## 障害回復

### リカバリプロセス

1. **ログ分析**: 先行書き込みログを解析して未完了トランザクションを特定
2. **ロールバック/ロールフォワード**: トランザクションの状態に応じて操作を取り消しまたは完了
3. **一貫性検証**: データ構造の整合性検証と必要に応じた修復
4. **チェックポイント復元**: 最新の有効なチェックポイントからの復元

## 関連コンポーネント

- **ファイルシステム**: PMEM対応ファイルシステム（NOVA, ext4-DAX等）との統合
- **仮想メモリマネージャ**: PMEMのメモリマッピング管理
- **階層横断最適化**: メモリ階層間のデータ移動の最適化
- **時空間メモリ圧縮**: PMEM容量の効率的な使用のための圧縮技術

## 将来の拡張

- **分散PMEM**: ネットワーク経由の透過的なPMEMアクセス
- **暗号化PMEM**: 保存データの透過的な暗号化
- **QoS管理**: 重要度に基づくPMEMリソースの割り当て
- **AIベース最適化**: 使用パターン学習によるデータ配置の自動最適化 